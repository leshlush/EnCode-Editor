<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <title>SnapCode Web</title>
    <link rel="icon" type="image/x-png" sizes="64x64 196x196" href="icon.png">

    <script src="https://cjrtnc.leaningtech.com/3_20250502_1261/loader.js"></script>

    <style>
      html { margin: 0; height: 100%; }
      body { margin: 0; height: 100%; overflow: hidden; }
    </style>

  </head>

  <body>

    <script>  // Add 'snap_loader' iframe
      var iframe = document.createElement('iframe');
      iframe.id = 'snap_loader'; iframe.width = '100%'; iframe.height = '100%';
      iframe.style = 'margin: 0; padding: 0; border: none;';
      iframe.src = 'https://reportmill.com/SnapCode/loader/#SnapCode';
      document.body.appendChild(iframe);
    </script>

  </body>

  <script src="cjdom.js"></script>
  <script>

      // Get window.location.hash
      var hash = window.location.hash;
      if (hash != null && hash.length > 2) {
        hash = hash.substring(1);
      }

      // preloadResources : preRes   (from cjGetRuntimeResources() )
      var initParams = { version:11, natives: cjdomNativeMethods, fetch: gitproxyFetch };
      var classPath = `/app${location.pathname}CJDom-2025.05.jar:` +
                      `/app${location.pathname}SnapCJ-2025.05.jar:` +
                      `/app${location.pathname}SnapKit-2025.05.jar:` +
                      `/app${location.pathname}SnapCode-2025.05.jar:` +
                      `/app${location.pathname}jdk.compiler.jar:` +
                      `/app${location.pathname}SnapBuilder-2025.05.jar:` +
                      `/app${location.pathname}Greenfoot-2025.05.jar`;

      async function myInit() {
        await cheerpjInit(initParams);
        await cheerpjRunMain("snapcode.app.App", classPath, hash);
      }
      myInit();

      // This function intercepts GitHub fetches to use proxy
      async function gitproxyFetch(url, method, postdata, headers) {

        // Get URL for proxy
        console.log('Looking at ' + url);
        if (url.includes('github') && !url.includes('cors-proxy'))
            url = 'https://cors-proxy.jeff-b76.workers.dev/?url=' + url;
        console.log('Fetching ' + url);

        // Get headers dictionary from headers array
        const headersDict = {};
        for (let i = 0; i < headers.length; i += 2) {
            headersDict[headers[i]] = headers[i + 1];
        }

        // Get options dictionary
        const options = {
            method: method,
            headers: headersDict,
        };
        if (postdata)
            options.body = postdata;

        // Get response
        const response = await fetch(url, options);

        // Get headers string
        let headersStr = '';
        response.headers.forEach((value, key) => headersStr += `${key}:${value}\r\n`);

        // Return JS object with status/headers/body
        return { status: response.status, headers: headersStr, body: response.body };
      }

  </script>

</html>