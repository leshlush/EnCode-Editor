@model SnapSaves.Models.Course

@using Microsoft.AspNetCore.Identity
@inject UserManager<SnapSaves.Auth.AppUser> UserManager
@inject SnapSaves.Helpers.PermissionHelper PermissionHelper

<h1>@Model.Name</h1>
<p>@Model.Description</p>

<!-- Tab navigation (unchanged) -->
<ul class="nav nav-tabs" id="courseDetailsTabs" role="tablist">
    @if (await PermissionHelper.UserHasPermissionAsync(await UserManager.GetUserAsync(User), "ViewStudents"))
    {
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="students-tab" data-bs-toggle="tab" data-bs-target="#students" type="button" role="tab" aria-controls="students" aria-selected="true">
                Students
            </button>
        </li>
    }
    <li class="nav-item" role="presentation">
        <button class="nav-link @(!(await PermissionHelper.UserHasPermissionAsync(await UserManager.GetUserAsync(User), "ViewStudents")) ? "active" : "")" id="templates-tab" data-bs-toggle="tab" data-bs-target="#templates" type="button" role="tab" aria-controls="templates" aria-selected="false">
            Templates
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="universalTemplates-tab" data-bs-toggle="tab" data-bs-target="#universalTemplates" type="button" role="tab" aria-controls="universalTemplates" aria-selected="false">
            Universal Templates
        </button>
    </li>
</ul>

<!-- Tab content -->
<div class="tab-content" id="courseDetailsTabContent">
    @if (await PermissionHelper.UserHasPermissionAsync(await UserManager.GetUserAsync(User), "ViewStudents"))
    {
        <div class="tab-pane fade show active" id="students" role="tabpanel" aria-labelledby="students-tab">
            @await Html.PartialAsync("_UserCourse", Model.UserCourses)
        </div>
    }
    <div class="tab-pane fade @(!(await PermissionHelper.UserHasPermissionAsync(await UserManager.GetUserAsync(User), "ViewStudents")) ? "show active" : "")" id="templates" role="tabpanel" aria-labelledby="templates-tab">
        <!-- Render the CourseTemplates as cards -->
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mt-2">
            @foreach (var ct in Model.CourseTemplates)
            {
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">
                                <a href="#" class="template-link text-decoration-none" data-template-id="@ct.TemplateId">
                                    @ct.Template.Name
                                </a>
                            </h5>
                            <p class="card-text text-muted">@ct.Template.Description</p>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
    <div class="tab-pane fade" id="universalTemplates" role="tabpanel" aria-labelledby="universalTemplates-tab">
        @Html.Partial("_UniversalTemplates", Model.UniversalTemplates)
    </div>
</div>

<!-- Bootstrap Modal for Template Details -->
<div class="modal fade" id="templateDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Template Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4" id="templateDetailsContent">
                <!-- AJAX-loaded content goes here -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).on('click', '.template-link', function(e) {
            e.preventDefault();
            var templateId = $(this).data('template-id');
            $('#templateDetailsContent').html('<div class="text-center">Loading...</div>');
            var modal = new bootstrap.Modal(document.getElementById('templateDetailsModal'));
            modal.show();
            $.get('/Templates/DetailsPartial', { id: templateId }, function(data) {
                $('#templateDetailsContent').html(data);
            });
        });

        $(document).on('submit', '#createProjectForm', function(e) {
            e.preventDefault();
            var $form = $(this);
            $.post($form.attr('action'), $form.serialize(), function() {
                $('#createProjectResult').html('<div class="alert alert-success">Project created!</div>');
                // Optionally reload the partial to show the new project
                var templateId = $form.find('input[name="templateId"]').val();
                $.get('/Templates/DetailsPartial', { id: templateId }, function(data) {
                    $('#templateDetailsContent').html(data);
                });
            }).fail(function(xhr) {
                $('#createProjectResult').html('<div class="alert alert-danger">' + xhr.responseText + '</div>');
            });
        });
    </script>
}
