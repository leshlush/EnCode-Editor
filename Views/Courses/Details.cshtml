@model SnapSaves.Models.Course

@using Microsoft.AspNetCore.Identity
@inject UserManager<SnapSaves.Auth.AppUser> UserManager
@inject SnapSaves.Helpers.PermissionHelper PermissionHelper

<h1>@Model.Name</h1>
<p>@Model.Description</p>

<!-- Tab navigation (unchanged) -->
<ul class="nav nav-tabs" id="courseDetailsTabs" role="tablist">
   
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="universalTemplates-tab" data-bs-toggle="tab" data-bs-target="#universalTemplates" type="button" role="tab" aria-controls="universalTemplates" aria-selected="true">
            Project Templates
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="templates-tab" data-bs-toggle="tab" data-bs-target="#templates" type="button" role="tab" aria-controls="templates" aria-selected="false">
            Teacher-Created Templates
        </button>
    </li>    
    @if (await PermissionHelper.UserHasPermissionAsync(await UserManager.GetUserAsync(User), "ViewStudents"))
    {
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="students-tab" data-bs-toggle="tab" data-bs-target="#students" type="button" role="tab" aria-controls="students" aria-selected="false">
                Students
            </button>
        </li>
    }
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="projects-tab" data-bs-toggle="tab" data-bs-target="#projects" type="button" role="tab" aria-controls="projects" aria-selected="false">
            Projects
        </button>
    </li>
    <!-- Add Learning Paths Tab -->
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="learningPaths-tab" data-bs-toggle="tab" data-bs-target="#learningPaths" type="button" role="tab" aria-controls="learningPaths" aria-selected="false">
            Learning Paths
        </button>
    </li>
</ul>

<!-- Tab content -->
<div class="tab-content" id="courseDetailsTabContent">
    @if (await PermissionHelper.UserHasPermissionAsync(await UserManager.GetUserAsync(User), "ViewStudents"))
    {
        <div class="tab-pane fade" id="students" role="tabpanel" aria-labelledby="students-tab">
            @await Html.PartialAsync("_UserCourse", Model.UserCourses)
        </div>
    }
    <div class="tab-pane fade" id="templates" role="tabpanel" aria-labelledby="templates-tab">
        <!-- Render the CourseTemplates as cards -->
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mt-2">
            @foreach (var ct in Model.CourseTemplates)
            {
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">
                                <a href="#" class="template-link text-decoration-none"
                                   data-template-id="@ct.TemplateId"
                                   data-course-id="@ct.CourseId">
                                    @ct.Template.Name
                                </a>
                            </h5>
                            <p class="card-text text-muted">@ct.Template.Description</p>
                        </div>
                    </div>
                </div>
            }

        </div>
    </div>
    <div class="tab-pane fade show active" id="universalTemplates" role="tabpanel" aria-labelledby="universalTemplates-tab">
        @{
            var viewData = new ViewDataDictionary(ViewData) { { "CourseId", Model.Id } };
        }
        <partial name="_UniversalTemplates" model="Model.UniversalTemplates" view-data="viewData" />

    </div>
    <div class="tab-pane fade" id="projects" role="tabpanel" aria-labelledby="projects-tab">
        <div id="courseProjectsContent" class="p-3 text-center text-muted">Loading projects...</div>
    </div>
    <!-- Tab content for Learning Paths -->
    <div class="tab-pane fade" id="learningPaths" role="tabpanel" aria-labelledby="learningPaths-tab">
        @if (ViewData["LearningPaths"] is List<SnapSaves.Models.LearningPath> learningPaths)
        {
            <!-- Sub-tabs for Learning Paths -->
            <ul class="nav nav-tabs" id="learningPathsSubTabs" role="tablist">
                @for (int i = 0; i < learningPaths.Count; i++)
                {
                    var path = learningPaths[i];
                    <li class="nav-item" role="presentation">
                        <button class="nav-link @(i == 0 ? "active" : "")" id="learningPath-@path.Id-tab" data-bs-toggle="tab" data-bs-target="#learningPath-@path.Id" type="button" role="tab" aria-controls="learningPath-@path.Id" aria-selected="@(i == 0)">
                            @path.Name
                        </button>
                    </li>
                }
            </ul>

            <!-- Sub-tab content for Learning Paths -->
            <div class="tab-content" id="learningPathsSubTabContent">
                @for (int i = 0; i < learningPaths.Count; i++)
                {
                    var path = learningPaths[i];
                    var learningPathId = $"learningPath-{path.Id}"; // Unique ID for each learning path
                    <div class="tab-pane fade @(i == 0 ? "show active" : "")" id="@learningPathId" role="tabpanel" aria-labelledby="learningPath-@path.Id-tab">
                        <div>
                            <p>@path.Description</p>

                            <!-- Bootstrap Accordion for Units -->
                            <div class="accordion" id="accordion-@learningPathId">
                                @foreach (var unit in path.Units.OrderBy(u => u.StartPosition))
                                {
                                    var unitId = $"unit-{unit.Name.Replace(" ", "-")}-{unit.StartPosition}-{learningPathId}";
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="heading-@unitId">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-@unitId" aria-expanded="false" aria-controls="collapse-@unitId">
                                                @unit.Name
                                            </button>
                                        </h2>
                                        <div id="collapse-@unitId" class="accordion-collapse collapse" aria-labelledby="heading-@unitId" data-bs-parent="#accordion-@learningPathId">
                                            <div class="accordion-body">
                                                <div class="container">
                                                    @foreach (var item in path.LearningPathItems
                                                        .Where(lpi => lpi.LearningItem.Position >= unit.StartPosition && lpi.LearningItem.Position <= unit.EndPosition)
                                                        .OrderBy(lpi => lpi.LearningItem.Position))
                                                    {
                                                        <div class="row align-items-center">
                                                            <div class="col-md-2">
                                                                @if (item.LearningItem.TemplateId != null)
                                                                {
                                                                    var templateDescription = item.LearningItem.Template?.Description ?? "No description available";
                                                                    <a href="#" class="template-link text-decoration-none"
                                                                       data-template-id="@item.LearningItem.TemplateId"
                                                                       data-course-id="@Model.Id">
                                                                        @item.LearningItem.Name
                                                                    </a>
                                                                }
                                                                else if (item.LearningItem.LessonId != null)
                                                                {
                                                                    var lessonDescription = item.LearningItem.Lesson?.Description ?? "No description available";
                                                                    <a href="javascript:void(0);" class="lesson-link text-decoration-none"
                                                                       data-lesson-id="@item.LearningItem.LessonId">
                                                                        @item.LearningItem.Name
                                                                    </a>
                                                                }
                                                                else
                                                                {
                                                                    @item.LearningItem.Name
                                                                }
                                                            </div>
                                                            <div class="col-md-2 text-muted">
                                                                @if (item.LearningItem.TemplateId != null)
                                                                {
                                                                    <span>Project Template</span>
                                                                }
                                                                else if (item.LearningItem.LessonId != null)
                                                                {
                                                                    <span>Lesson</span>
                                                                }
                                                                else
                                                                {
                                                                    <span>Unknown</span>
                                                                }
                                                            </div>
                                                            <div class="col-md-8">
                                                                @if (item.LearningItem.TemplateId != null)
                                                                {
                                                                    var templateDescription = item.LearningItem.Template?.Description ?? "No description available";
                                                                    <span class="text-muted">@templateDescription</span>
                                                                }
                                                                else if (item.LearningItem.LessonId != null)
                                                                {
                                                                    var lessonDescription = item.LearningItem.Lesson?.Description ?? "No description available";
                                                                    <span class="text-muted">@lessonDescription</span>
                                                                }
                                                                else
                                                                {
                                                                    <span class="text-muted">No description available</span>
                                                                }
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <p>No learning paths available.</p>
        }
    </div>
</div>

<!-- Bootstrap Modal for Template Details -->
<div class="modal fade" id="templateDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Template Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4" id="templateDetailsContent">
                <!-- AJAX-loaded content goes here -->
            </div>
        </div>
    </div>
</div>

<!--- Bootstrap Modal for Student projects -->
<div class="modal fade" id="studentProjectsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Student Projects</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4" id="studentProjectsContent">
                <!-- AJAX-loaded content goes here -->
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap Modal for Lesson -->
<div class="modal fade" id="lessonModal" tabindex="-1" aria-labelledby="lessonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl"> <!-- Use 'modal-xl' for a very large modal -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="lessonModalLabel">Lesson</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="lessonModalContent" class="text-center">
                    <p>Loading lesson...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .project-card:hover {
        box-shadow: 0 0 0 0.2rem #6366f1;
        background: #f8fafc;
        transition: box-shadow 0.2s, background 0.2s;
    }
</style>

@section Scripts {
    <script>
            $(document).on('click', '.template-link', function(e) {
            e.preventDefault();
            var templateId = $(this).data('template-id');
            var courseId = $(this).data('course-id'); // Add this!
			console.log("on click, CourseId: " + courseId);
            $('#templateDetailsContent').html('<div class="text-center">Loading...</div>');
            var modal = new bootstrap.Modal(document.getElementById('templateDetailsModal'));
            modal.show();
            $.get('/Templates/DetailsPartial', { id: templateId, courseId: courseId }, function(data) {
                $('#templateDetailsContent').html(data);
            });
        });

            $(document).on('click', '.student-projects-link', function(e) {
            e.preventDefault();
            var userId = $(this).data('user-id');
            var courseId = $(this).data('course-id');
            $('#studentProjectsContent').html('<div class="text-center">Loading...</div>');
            $.get('/Students/StudentProjectsPartial', { userId: userId, courseId: courseId }, function(data) {
                $('#studentProjectsContent').html(data);
            });
        });

        $(document).on('shown.bs.tab', '#projects-tab', function (e) {
            var courseId = @Model.Id;
            $('#courseProjectsContent').html('Loading projects...');
            $.get('/Courses/CourseProjects', { id: courseId }, function (data) {
                $('#courseProjectsContent').html(data);
            });
        });

        $(document).on('submit', '#createProjectForm', function(e) {
            e.preventDefault();
            var $form = $(this);
            $.post($form.attr('action'), $form.serialize(), function() {
                $('#createProjectResult').html('<div class="alert alert-success">Project created!</div>');
                // Optionally reload the partial to show the new project
                var templateId = $form.find('input[name="templateId"]').val();
                var courseId = $form.find('input[name="courseId"]').val();
				console.log("on submit, CourseId: " + courseId);
                $.get('/Templates/DetailsPartial', { id: templateId, courseId: courseId }, function(data) {
                    $('#templateDetailsContent').html(data);
                });
            }).fail(function(xhr) {
                $('#createProjectResult').html('<div class="alert alert-danger">' + xhr.responseText + '</div>');
            });
        });

        $(document).on('click', '.lesson-link', function (e) {
            e.preventDefault();

            var lessonId = $(this).data('lesson-id'); // Get the lesson ID from the data attribute
            $('#lessonModalContent').html('<div class="text-center">Loading lesson...</div>'); // Show loading message

            var lessonModal = new bootstrap.Modal(document.getElementById('lessonModal')); // Initialize the modal
            lessonModal.show(); // Show the modal

            // Make an AJAX request to fetch the lesson content
            $.get('/Lesson/Index', { lessonId: lessonId }, function (data) {
                $('#lessonModalContent').html(data); // Load the lesson content into the modal
            }).fail(function () {
                $('#lessonModalContent').html('<div class="text-danger">Failed to load lesson. Please try again later.</div>');
            });
        });
    </script>
}
