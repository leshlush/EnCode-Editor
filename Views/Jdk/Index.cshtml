@{
    Layout = null;
    ViewData["Title"] = "CheerpJ Test";
    var projectJson = ViewData["ProjectJson"] as string;
    var projectId = ViewData["ProjectId"] as string;
}

<h1>Loading Coding Environment...</h1>
<div id="cheerpj-container" style="position: relative; height: 600px; width: 800px; margin: 0 auto; border: 1px solid #ccc;"></div>

<script src="https://cjrtnc.leaningtech.com/4.0/loader.js"></script>
<script src="/Jdk/cjdom.js"></script>
<script>
    (async function () {
        try {
            // Initialize CheerpJ
            var initParams = { version: 11, natives: cjdomNativeMethods };
            var classPath = "/app/Jdk/CJDom-2025.05.jar:" +
                            "/app/Jdk/SnapCJ-2025.05.jar:" +
                            "/app/Jdk/SnapKit-2025.05.jar:" +
                            "/app/Jdk/SnapCode-2025.05.jar:" +
                            "/app/Jdk/jdk.compiler.jar:" +
                            "/app/Jdk/SnapBuilder-2025.05.jar:" +
                            "/app/Jdk/Greenfoot-2025.05.jar";

            console.log("Initializing CheerpJ...");
            await cheerpjInit(initParams);
            console.log("CheerpJ initialized successfully.");
            await cheerpjRunJar("/app/CreateFileCheerpJ.jar");

            // Parse the project JSON from ViewData
             const projectJsonString = @Html.Raw(Json.Serialize(projectJson ?? ""));
             console.log(projectJsonString);
             cheerpOSAddStringFile("/str/project.json", projectJsonString);

            // Run JAR to copy from /str/ to /files/
            await cheerpjRunJar("/app/CreateSnapCodeProjectCheerpJ.jar");

            // Create the display inside the container
            const container = document.getElementById("cheerpj-container");

            console.log("Running main class...");
            await cheerpjRunMain("snapcode.app.App", classPath, ["open:/files/@projectId"]);
            console.log("Main class executed successfully.");
        } catch (error) {
            console.error("Error initializing or running CheerpJ:", error);
        }
    })();

        function base64ToUint8Array(base64) {
        const binary = atob(base64);
        const len = binary.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binary.charCodeAt(i);
        }
        return bytes;
    }



</script>