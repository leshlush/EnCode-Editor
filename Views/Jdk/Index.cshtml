@{
    Layout = null;
    ViewData["Title"] = "CheerpJ Test";
    var projectJson = ViewData["ProjectJson"] as string;
}

<h1>Loading Coding Environment...</h1>
<div id="cheerpj-container" style="position: relative; height: 600px; width: 800px; margin: 0 auto; border: 1px solid #ccc;"></div>

<script src="https://cjrtnc.leaningtech.com/4.0/loader.js"></script>
<script src="/Jdk/cjdom.js"></script>
<script>
    (async function () {
        try {
            // Initialize CheerpJ
            var initParams = { version: 11, natives: cjdomNativeMethods };
            var classPath = "/app/Jdk/CJDom-2025.05.jar:" +
                            "/app/Jdk/SnapCJ-2025.05.jar:" +
                            "/app/Jdk/SnapKit-2025.05.jar:" +
                            "/app/Jdk/SnapCode-2025.05.jar:" +
                            "/app/Jdk/jdk.compiler.jar:" +
                            "/app/Jdk/SnapBuilder-2025.05.jar:" +
                            "/app/Jdk/Greenfoot-2025.05.jar";

            console.log("Initializing CheerpJ...");
            await cheerpjInit(initParams);
            console.log("CheerpJ initialized successfully.");

            // Parse the project JSON
            const project = @Html.Raw(projectJson);
            console.log(project);

            // Write files into IndexedDB
            await writeFilesToIndexedDB(project.Files);

            // Create the display inside the container
            const container = document.getElementById("cheerpj-container");

            console.log("Running main class...");
            await cheerpjRunMain("snapcode.app.App", classPath);
            console.log("Main class executed successfully.");
        } catch (error) {
            console.error("Error initializing or running CheerpJ:", error);
        }

        // Function to write files into IndexedDB
        async function writeFilesToIndexedDB(files) {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open("cjFS_/files/", 1);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains("files")) {
                        db.createObjectStore("files");
                        console.log("Object store 'files' created.");
                    }
                };

                request.onsuccess = (event) => {
                    const db = event.target.result;
                    const transaction = db.transaction("files", "readwrite");
                    const store = transaction.objectStore("files");

                    files.forEach(file => {
                        // Ensure the file object includes a valid 'path' property
                        if (!file.path) {
                            console.error("File is missing the 'path' property:", file);
                            return;
                        }

                        const fileData = {
                            content: new TextEncoder().encode(file.content), // Convert content to Uint8Array
                            isDirectory: file.isDirectory || false // Default to false if not provided
                        };

                        store.put(fileData, file.path); // Use 'put' to insert or update the file
                        console.log(`File written: ${file.path}`);
                    });

                    transaction.oncomplete = () => {
                        console.log("All files written to IndexedDB successfully.");
                        resolve();
                    };

                    transaction.onerror = (event) => {
                        console.error("Error writing files to IndexedDB:", event.target.error);
                        reject(event.target.error);
                    };
                };

                request.onerror = (event) => {
                    console.error("Error opening IndexedDB:", event.target.error);
                    reject(event.target.error);
                };
            });
        }
    })();
</script>
